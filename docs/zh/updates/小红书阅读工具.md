# 小红书阅读工具（read_rednote）

本项目提供 **read_rednote** 工具，供 Agent 读取小红书笔记的标题、正文、作者、标签、点赞/评论数及配图（以图片形式供模型分析）。Chrome 调试模式相关配置放在 **ChromeDebugConfig**（`tools.chromeDebug`）下，供 read_rednote 及其他依赖浏览器调试端口的工具共用；read_rednote 独有配置在 `tools.rednote` 下。

---

## 1. 功能说明

- **工具名**：`read_rednote`
- **输入**：小红书笔记链接（支持 xhslink.com 短链或 xiaohongshu.com 完整链接）。
- **输出**：标题、作者、标签、点赞/评论数、正文文字；配图以「图片」形式返回，模型可看图分析。
- **Chrome 进程与网关同生命周期**：  
  本程序**可以**在 **nanobot gateway**（`nanobot run`）启动时**自动启动一个 Chrome 进程**并进入调试模式；**Ctrl+C 关掉 nanobot gateway 后，会自动关闭该 Chrome 进程**，无需用户手动关浏览器。是否自动启动由 `tools.chromeDebug.autoStartChrome` 控制（默认 true）。
- **依赖**：
  - 本机安装 **Chrome 或 Chromium**（由本程序在上述时机自动启动，或用户手动以调试端口启动）。
  - Python 仅需安装 **Playwright 库**：`pip install playwright`。  
    本程序用 **chrome_launcher** 启动系统已安装的 Chrome，read_rednote 再通过 Playwright 的 CDP 连接该进程；因此**不需要**执行 `playwright install chromium`（那是给 Playwright 自己拉起浏览器用的，此处我们只用到 Playwright 的 CDP 客户端能力）。

---

## 2. 配置结构

### 2.1 共用：ChromeDebugConfig（tools.chromeDebug）

供 read_rednote 及今后其他依赖 Chrome 调试的工具共用：

| 字段 | 类型 | 默认 | 说明 |
|------|------|------|------|
| **cdpPort** | int | 19327 | 远程调试端口（默认用不易碰撞的端口） |
| **autoStartChrome** | bool | true | 是否由本进程在启动时自动启动 Chrome 调试模式 |

### 2.2 read_rednote 专用：RedNoteConfig（tools.rednote）

| 字段 | 类型 | 默认 | 说明 |
|------|------|------|------|
| **maxImages** | int | 20 | 单篇笔记最多返回的图片数（0 表示不返回图片） |

示例：

```json
"tools": {
  "chromeDebug": {
    "cdpPort": 19327,
    "autoStartChrome": true
  },
  "rednote": {
    "maxImages": 20
  }
}
```

---

## 3. 自动启动 Chrome 调试模式

- 使用 **`nanobot gateway`** 启动网关时，若 `tools.chromeDebug.autoStartChrome` 为 true（默认），本程序会**自动启动一个 Chrome 进程**，并开启 `tools.chromeDebug.cdpPort`（默认 19327），供 read_rednote 等工具连接。
- 该 Chrome 使用独立用户数据目录（如 `~/.nanobot/rednote/chrome_profile`），与用户日常使用的 Chrome 互不干扰；**首次使用需在此自动打开的 Chrome 窗口中登录小红书**，登录态会保留。
- **网关退出时（含 Ctrl+C）会自动关闭该 Chrome 进程**，不会残留浏览器进程。

若不需要自动启动（例如已自行用固定端口开好 Chrome），在 config 中设置：

```json
"tools": {
  "chromeDebug": {
    "autoStartChrome": false,
    "cdpPort": 19327
  }
}
```

---

## 4. 小红书登录方式

- **方式一（推荐）**：先运行 `nanobot gateway`，在自动弹出的 Chrome 窗口中打开小红书并登录，登录态会保存在该 Chrome 的 profile 中。
- **方式二**：使用 **`nanobot rednote login`** 单独完成登录并保存状态到 `~/.nanobot/rednote/auth.json`：
  1. 确保 Chrome 已以调试端口运行（例如先 `nanobot gateway` 让程序自动启动 Chrome，或手动以 `--remote-debugging-port=19327` 启动）。
  2. 执行：`nanobot rednote login`（默认端口 19327，与 `tools.chromeDebug.cdpPort` 一致；若不同可用 `-p` 指定）。
  3. 会通过 **Playwright** 连接该 Chrome 并打开小红书探索页，在浏览器中登录后，按提示等待或 Ctrl+C 结束，登录态（cookies/localStorage）会保存到 `~/.nanobot/rednote/auth.json`。之后 `read_rednote` 会优先加载该文件以使用已登录态。
  - **仅依赖 Playwright**（`pip install playwright`），无需 Node.js 或 agent-browser。

---

## 5. 使用方式

- Agent 在对话中调用工具时传入笔记链接即可，例如：
  - `read_rednote(url="https://xhslink.com/xxxxx")`
  - `read_rednote(url="https://www.xiaohongshu.com/explore/xxxxx")`
- 若由本程序自动启动 Chrome，首次使用前请在该 Chrome 窗口中完成小红书登录；之后同一 profile 会保持登录态。

---

## 6. 仅用 agent / cron run 时

- 使用 **`nanobot agent`** 或 **`nanobot cron run`** 等命令时，**不会**自动启动 Chrome；read_rednote 仍会注册，但若要生效，需要：
  - 本机已有 Chrome 以调试模式运行，且端口与 config 中 `tools.chromeDebug.cdpPort` 一致，或  
  - 先通过 **`nanobot gateway`** 启动网关（此时会按配置自动启动 Chrome），再在其它终端用 agent/cron 等。

---

## 7. 相关代码

- **配置**：`nanobot/config/schema.py` — `ChromeDebugConfig`（cdp_port、auto_start_chrome）、`RedNoteConfig`（max_images）、`ToolsConfig.chrome_debug` / `ToolsConfig.rednote`。
- **Chrome 启动**：`nanobot/utils/chrome_launcher.py` — `start_chrome_debug(port, user_data_dir, headless)`；在 `nanobot/cli/commands.py` 的 `gateway` 中根据 `tools.chromeDebug.autoStartChrome` 调用，并在退出时 terminate 子进程。
- **RedNote 登录命令**：`nanobot/cli/commands.py` — `rednote_app`、`rednote login`（用 Playwright 连接 Chrome、打开小红书探索页，保存 `context.storage_state` 到 `~/.nanobot/rednote/auth.json`；`read_rednote` 会优先加载该文件以恢复登录态）。
- **工具实现**：`nanobot/agent/tools/rednote.py` — `ReadRedNoteTool`（从 `chrome_debug_config` 取端口，从 `rednote_config` 取 max_images；连接 CDP、打开笔记页、抽取正文与图片）。
- **注册**：`nanobot/agent/loop.py` — 当存在 `rednote_config` 时注册 `ReadRedNoteTool`，`cdp_port` 来自 `chrome_debug_config`。

---

## 更新日期

2025-03
