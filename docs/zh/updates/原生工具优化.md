# 原生工具优化

本项目对内置文件与编辑工具做了如下优化，便于 Agent 更高效地读文件、看图片和改内容。

---

## 1. read_file：支持图片与按行读取

### 1.1 读图片

- **支持格式**：jpg、png、gif、webp。
- **行为**：对图片文件不再按文本打开，而是以 base64 编码成「图像 URL」格式返回，由模型进行视觉分析（看图、OCR、图表等）。
- **说明**：read_file 仅把图片提供给模型分析，**不会**把图片发给用户；若要发给用户，需使用 `message` 工具的 `media_paths` 参数。

### 1.2 按行范围读取

- **参数**  
  - `line_offset`：起始行号（从 1 开始）。不传则从第 1 行开始。  
  - `n_lines`：读取行数，默认 1000，最大 1000。
- **输出**  
  - 带行号（类似 `cat -n`）。  
  - 若只读了一部分或显式指定了范围，会带头部说明，例如：`[Lines 1-100 of 500]`。  
  - 单行过长会截断并标注 `[truncated]`（长度由 `max_line_length` 控制，默认 2000）。

### 1.3 二进制与错误处理

- 非文本文件（无法用 UTF-8 解码）会返回明确错误信息，并给出文件大小，避免乱码或崩溃。

**示例**

- 读全文（默认前 1000 行）：`read_file(path="path/to/file")`
- 从第 10 行起读 50 行：`read_file(path="path/to/file", line_offset=10, n_lines=50)`
- 读图片：`read_file(path="screenshot.png")`，模型会收到图片内容并进行分析。

---

## 2. edit_file：支持「全部替换」避免整文件重写

### 2.1 问题

- 仅支持「找到一段 old_text，替换成 new_text」且默认只替第一次。  
- 若同一段文字出现多次，需多次调用或重写整文件，既不安全也不省 token。

### 2.2 优化：replace_all

- **参数**  
  - `old_text` / `new_text`：与原来一致。  
  - `replace_all`：  
    - `false`（默认）：只替换**第一次**出现；若出现多次会提示「提供更多上下文以唯一定位，或设 replace_all=true 全部替换」。  
    - `true`：替换**所有**出现，并返回替换次数。
- **效果**：一次调用即可完成全文多处相同内容的替换，无需先 read 再 write 整份文件，减少 token 与出错面。

**示例**

- 只改第一处：`edit_file(path="config.json", old_text="\"port\": 8080", new_text="\"port\": 9090")`
- 全部替换：`edit_file(path="notes.md", old_text="TODO", new_text="DONE", replace_all=true)`

---

## 3. 相关代码位置

- **read_file**：`nanobot/agent/tools/filesystem.py` — `ReadFileTool`（图片检测与 base64、line_offset/n_lines、行号与截断、二进制错误处理）。  
- **edit_file**：同文件 — `EditFileTool`（replace_all 参数与逻辑）。  
- **多模态结果**：`nanobot/agent/loop.py` — 对工具返回的 list（如图片 + 文本）做解析，将图片部分注入下一轮 user 消息供模型分析；`nanobot/agent/tools/registry.py` — 支持工具返回 `str | list[dict]` 及参数归一化（单元素 list 转 dict）。

---

## 更新日期

2025-03
